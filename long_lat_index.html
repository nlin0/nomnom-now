<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Distance and Rating Scatterplot</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>
    <script>
        async function user_actions(click_info) {
            click_info = [42.3601, -71.0589];  // Coordinates for Boston

            try {
                // Wait for the promise to resolve and get the JSON result
                const distance_json = await loadAndCalculateDistances(click_info[0], click_info[1]);
                console.log(distance_json);  // Log the JSON once resolved

                // After calculating distances, generate the scatter plot
                createScatterPlot(distance_json);
            } catch (error) {
                console.error("Error:", error);  // Handle any errors
            }
        }

        // The Haversine formula to calculate distance between two lat/lng points
        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);

            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c * 0.6214; // distance in miles
        }

        // Function to load CSV and calculate distances, with normalization based on review_count
        function loadAndCalculateDistances(lat, lon) {
            return new Promise((resolve, reject) => {
                // Load the CSV file
                d3.csv("data/yelp_boston.csv").then(function(data) {
                    let results = []; // Initialize an array to store the results

                    // Loop through each restaurant and calculate distance and normalized rating
                    data.forEach(function(restaurant) {
                        // Parse the latitude and longitude from the CSV data
                        const restLat = parseFloat(restaurant.latitude);
                        const restLon = parseFloat(restaurant.longitude);
                        const reviewCount = parseInt(restaurant.review_count); // Get the review count
                        const rating = parseFloat(restaurant.rating);

                        // Normalize the rating based on review count (with k = 10 as an example)
                        const k = 10;
                        const normalizedRating = rating * reviewCount / (reviewCount + k);

                        // Calculate the distance using the Haversine formula
                        const distance = haversine(lat, lon, restLat, restLon);

                        // Store the result as an object with name, distance, and normalized rating
                        results.push({
                            name: restaurant.name,
                            distance: distance.toFixed(2), // Store distance with 2 decimal places
                            normalizedRating: normalizedRating.toFixed(2), // Normalized rating
                        });
                    });

                    // Resolve the promise with the results (returning the JSON)
                    resolve(results);
                }).catch(function(error) {
                    // Reject the promise in case of an error
                    reject("Error loading the CSV file: " + error);
                });
            });
        }

        // Function to create a scatter plot with D3.js, including zoom functionality
        function createScatterPlot(data) {
            // Set the dimensions of the plot
            const margin = { top: 20, right: 30, bottom: 40, left: 40 };
            const width = 800 - margin.left - margin.right;
            const height = 600 - margin.top - margin.bottom;

            // Create the SVG element for the scatter plot
            const svg = d3.select("body").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // Create the x and y scales
            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseFloat(d.distance))])
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.normalizedRating)])
                .range([height, 0]);

            // Create the x and y axes
            const xAxis = svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x));

            const yAxis = svg.append("g")
                .call(d3.axisLeft(y));

            // Add the points (circles) for each restaurant
            const circles = svg.selectAll("dot")
                .data(data)
                .enter().append("circle")
                .attr("cx", d => x(d.distance))
                .attr("cy", d => y(d.normalizedRating))
                .attr("r", 5)
                .attr("fill", "blue");

            // Add labels for axes
            svg.append("text")
                .attr("transform", "translate(" + (width / 2) + "," + (height + margin.bottom) + ")")
                .style("text-anchor", "middle")
                .text("Distance (miles)");

            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .style("text-anchor", "middle")
                .text("Normalized Rating");

            // Zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([1, 10]) // Set zoom scale limits
                .translateExtent([[0, 0], [width, height]]) // Set panning limits
                .on("zoom", function(event) {
                    // Get new scale values after zooming
                    const newX = event.transform.rescaleX(x);
                    const newY = event.transform.rescaleY(y);

                    // Update the position of the circles
                    circles.attr("cx", d => newX(d.distance))
                        .attr("cy", d => newY(d.normalizedRating));

                    // Update the axes
                    xAxis.call(d3.axisBottom(newX));
                    yAxis.call(d3.axisLeft(newY));
                });

            // Apply the zoom behavior to the SVG
            svg.call(zoom);
        }

        // Call the user_actions function with actual coordinates
        user_actions([42.3601, -71.0589]);  // Example: Coordinates for Boston
    </script>
</body>
</html>
